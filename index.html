<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat Relief Network</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .filters {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 250px;
        }
        
        .filters h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .filter-option {
            margin: 5px 0;
            font-size: 13px;
        }
        
        .filter-option input {
            margin-right: 5px;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .status-open {
            color: green;
            font-weight: bold;
        }
        
        .status-closed {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="filters">
        <h3>Filters</h3>
        
        <div class="filter-group">
            <label>Status</label>
            <div class="filter-option">
                <input type="checkbox" id="filter-open" checked>
                <label for="filter-open">Open Now</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="filter-closed" checked>
                <label for="filter-closed">Closed Now</label>
            </div>
        </div>
        
        <button onclick="resetFilters()" style="width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Reset Filters</button>
    </div>
    
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
        const map = L.map('map');
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        
        let allSites = [];
        let markers = L.layerGroup().addTo(map);
        
        // Custom icons for each site type
        const icons = {
            'Cooling Center': L.icon({
                iconUrl: 'https://azmag.gov/portals/0/Heat-Relief/hrn-icon-cooling.png',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -37]
            }),
            'Respite Center': L.icon({
                iconUrl: 'https://azmag.gov/portals/0/Heat-Relief/hrn-icon-respite.png',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -37]
            }),
            'Hydration Station': L.icon({
                iconUrl: 'https://azmag.gov/portals/0/Heat-Relief/hrn-icon-hydration.png',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -37]
            }),
            'Collection Site': L.icon({
                iconUrl: 'https://azmag.gov/portals/0/Heat-Relief/hrn-icon-donation.png',
                iconSize: [32, 37],
                iconAnchor: [16, 37],
                popupAnchor: [0, -37]
            })
        };
        
        // Add event listeners to filters
        document.querySelectorAll('.filter-option input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateMap);
        });
        
        // Load data
        Papa.parse('data/public/sites.csv', {
            download: true,
            header: true,
            complete: function(results) {
                // Filter out rows with missing coordinates
                allSites = results.data.filter(site => {
                    const hasLat = site.latitude && site.latitude.trim() !== '';
                    const hasLng = site.longitude && site.longitude.trim() !== '';
                    const validLat = hasLat && !isNaN(parseFloat(site.latitude));
                    const validLng = hasLng && !isNaN(parseFloat(site.longitude));
                    return validLat && validLng;
                });
                
                console.log(`Loaded ${allSites.length} sites with valid coordinates`);
                updateMap();
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
            }
        });
        
        function parseTimeString(timeStr) {
            // Handle various time formats: "9:00 AM", "09:00", "9:00", etc.
            if (!timeStr || timeStr.trim() === '') return null;
            
            timeStr = timeStr.trim();
            
            // Check for AM/PM format
            const ampmMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (ampmMatch) {
                let hour = parseInt(ampmMatch[1]);
                const min = parseInt(ampmMatch[2]);
                const period = ampmMatch[3].toUpperCase();
                
                if (period === 'PM' && hour !== 12) hour += 12;
                if (period === 'AM' && hour === 12) hour = 0;
                
                return hour * 60 + min;
            }
            
            // Check for 24-hour format
            const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                const hour = parseInt(timeMatch[1]);
                const min = parseInt(timeMatch[2]);
                return hour * 60 + min;
            }
            
            return null;
        }
        
        function isOpenNow(site) {
            const now = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = dayNames[now.getDay()];
            const currentTime = now.getHours() * 60 + now.getMinutes(); // minutes since midnight
            
            // Check if closed today (special closures)
            const todayDate = now.toISOString().split('T')[0];
            const closureDates = (site.special_closure_dates || '').split(',').map(d => d.trim());
            if (closureDates.includes(todayDate)) {
                return false;
            }
            
            // Get today's hours
            const hoursField = `${today}_hours`;
            const todayHours = site[hoursField];
            
            if (!todayHours || todayHours.trim() === '') {
                return false; // Closed today
            }
            
            // Parse hours (format: "HH:MM AM/PM - HH:MM AM/PM" or "HH:MM - HH:MM")
            const parts = todayHours.split('-');
            if (parts.length !== 2) {
                return false; // Can't parse hours
            }
            
            const openTime = parseTimeString(parts[0]);
            const closeTime = parseTimeString(parts[1]);
            
            if (openTime === null || closeTime === null) {
                return false; // Can't parse times
            }
            
            // Handle times that cross midnight
            if (closeTime < openTime) {
                return currentTime >= openTime || currentTime < closeTime;
            }
            
            return currentTime >= openTime && currentTime < closeTime;
        }
        
        function updateMap() {
            markers.clearLayers();
            
            // Get active filters
            const showOpen = document.getElementById('filter-open').checked;
            const showClosed = document.getElementById('filter-closed').checked;
            
            // Filter sites based on status
            const filteredSites = allSites.filter(site => {
                const isOpen = isOpenNow(site);
                
                // If both filters are checked, show all sites
                if (showOpen && showClosed) return true;
                
                // If only one filter is checked, show only matching sites
                if (showOpen && isOpen) return true;
                if (showClosed && !isOpen) return true;
                
                return false;
            });
            
            console.log(`Showing ${filteredSites.length} of ${allSites.length} sites`);
            
            // Add markers with custom icons
            filteredSites.forEach(site => {
                const isOpen = isOpenNow(site);
                const statusClass = isOpen ? 'status-open' : 'status-closed';
                const statusText = isOpen ? 'ðŸŸ¢ OPEN NOW' : 'ðŸ”´ CLOSED';
                
                // Get the appropriate icon for this site type
                const icon = icons[site.site_type] || icons['Cooling Center'];
                
                const lat = parseFloat(site.latitude);
                const lng = parseFloat(site.longitude);
                
                L.marker([lat, lng], { icon: icon })
                    .bindPopup(`
                        <b>${site.site_name || 'Unnamed Site'}</b><br>
                        <span class="${statusClass}">${statusText}</span><br>
                        ${site.site_type || 'Unknown Type'}<br>
                        ${site.address || ''}, ${site.city || ''}<br>
                        <b>Hours:</b> ${site.full_schedule || 'Not available'}<br>
                        ${site.services_offered ? `<b>Services:</b> ${site.services_offered}` : ''}
                    `)
                    .addTo(markers);
            });
            
            // Auto-fit map to show all filtered markers
            if (filteredSites.length > 0) {
                const bounds = L.latLngBounds(
                    filteredSites.map(site => [parseFloat(site.latitude), parseFloat(site.longitude)])
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function resetFilters() {
            document.querySelectorAll('.filter-option input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateMap();
        }
        
        // Update map every minute to keep open/closed status current
        setInterval(updateMap, 60000);
    </script>
</body>
</html>
